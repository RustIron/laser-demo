# 激光二极管测试设备仿真环境 - 项目说明文档

## 📖 项目简介

### 项目背景
激光二极管测试设备仿真环境是一个高精度的Python仿真系统，旨在为激光二极管的自动化测试提供逼真的设备模拟。该项目包含了完整的运动控制系统、3D可视化界面、安全保护机制和专业的命令接口，能够准确模拟实际测试设备的各项功能。

### 技术特色
- **高精度控制**：微米级定位精度（0.1μm）
- **多轴协调**：6自由度平台协同运动
- **安全可靠**：实时碰撞检测和紧急保护
- **专业界面**：现代化Qt图形界面
- **标准化接口**：JSON命令系统

---

## 🏗️ 系统架构

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    GUI 用户界面层                           │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │   主窗口    │  3D可视化   │  控制面板   │  状态监控   │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   应用逻辑层                               │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 系统控制器  │  命令处理器  │  状态管理器  │  配置管理器  │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   核心仿真层                               │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 6轴平台控制  │ 3轴龙门控制 │ 探针平台控制 │ 碰撞检测系统│   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │  S型轨迹规划 │ 运动状态管理 │  安全联锁   │ 数据结构定义│   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块说明

#### 1. 核心仿真层（core/）
**功能**：提供设备仿真的底层算法和数据结构

**主要模块**：
- `data_structures.py`：定义Vector3D、StagePosition等基础数据结构
- `motion_controller.py`：实现S型曲线轨迹规划算法
- `stage_controllers.py`：各阶段控制器具体实现
- `collision_detector.py`：实时碰撞检测和安全系统
- `system_controller.py`：系统级协调和管理

#### 2. 图形界面层（gui/）
**功能**：提供用户交互和可视化界面

**主要模块**：
- `main_window.py`：主窗口和布局管理
- `visualization.py`：3D可视化渲染
- `control_panels.py`：各种控制面板组件
- `widgets/`：可复用的UI控件

#### 3. 配置管理层（config/）
**功能**：系统配置、命令验证和持久化存储

**主要模块**：
- `command_schema.py`：JSON命令验证和处理
- `settings_manager.py`：系统设置管理
- `command_schema.json`：命令模式定义文件

---

## 🔧 核心功能详解

### 1. 运动控制系统

#### S型曲线轨迹规划
采用7段式S型曲线规划，确保运动平滑无冲击：

```
加加速度期 → 恒定加速期 → 减加速度期 → 匀速期 → 加减速期 → 恒定减速期 → 减减速期
     │           │           │           │           │           │           │
   t1          t2          t3         t4          t5          t6          t7
```

**算法特点**：
- 限制加加速度（Jerk），避免机械冲击
- 速度和加速度连续变化
- 最优化运动时间
- 支持起点/终点非零速度

#### 实时位置更新
1kHz频率的实时位置更新系统：
```python
# 1kHz更新循环
def update_loop():
    while running:
        start_time = time.time()

        # 更新所有阶段位置
        for stage in stages:
            stage.update()

        # 检查碰撞
        collision_detector.check_collisions()

        # 处理命令队列
        process_commands()

        # 维持1kHz频率
        elapsed = time.time() - start_time
        if elapsed < 0.001:
            time.sleep(0.001 - elapsed)
```

### 2. 安全保护系统

#### 碰撞检测算法
基于包围盒的快速碰撞检测：

```python
def calculate_box_distance(bbox1, bbox2):
    """计算两个包围盒之间的最小距离"""
    if bbox1.intersects(bbox2):
        return 0.0

    # 各轴上的分离距离
    dx = max(0, max(bbox1.min.x - bbox2.max.x,
                    bbox2.min.x - bbox1.max.x))
    dy = max(0, max(bbox1.min.y - bbox2.max.y,
                    bbox2.min.y - bbox1.max.y))
    dz = max(0, max(bbox1.min.z - bbox2.max.z,
                    bbox2.min.z - bbox1.max.z))

    # 欧几里得距离
    return (dx**2 + dy**2 + dz**2) ** 0.5
```

#### 预测性安全
2秒提前预测可能的碰撞：
- 基于当前速度预测未来位置
- 计算预测轨迹的安全间隙
- 提前预警和自动停止

### 3. 3D可视化系统

#### 渲染管线
使用PyVista实现的3D渲染系统：
```python
def setup_visualization():
    """设置3D可视化环境"""
    # 创建渲染器
    plotter = QtInteractor(container)

    # 添加光源
    add_lighting(plotter)

    # 创建设备模型
    create_stage_meshes(plotter)

    # 添加安全区域
    create_safety_zones(plotter)

    # 设置初始相机
    setup_camera(plotter)
```

#### 实时更新策略
- 20FPS可视化更新率
- 异步数据更新，不影响控制精度
- 平滑相机和视角控制
- 历史轨迹可视化

---

## 📡 命令接口系统

### JSON命令协议

#### 命令结构标准
```json
{
  "command_id": "唯一命令标识符",
  "command_type": "命令类型",
  "target_stage": "目标阶段（可选）",
  "parameters": {
    // 命令特定参数
  },
  "execution": {
    "mode": "执行模式（immediate/queued）",
    "priority": "优先级（1-10）",
    "timeout": "超时时间（秒）"
  }
}
```

#### 验证机制
- JSON Schema语法验证
- 参数类型和范围检查
- 阶段特定限制验证
- 逻辑一致性检查

### 命令处理流程

```
JSON输入 → 语法验证 → 逻辑验证 → 队列管理 → 执行控制 → 结果反馈
    │           │           │           │           │           │
    ↓           ↓           ↓           ↓           ↓           ↓
  格式检查    Schema验证   参数检查    优先级排序   状态监控   结果记录
```

---

## 🎮 用户交互指南

### 启动和初始化

#### 系统启动
```bash
# 安装依赖
pip install -r requirements.txt

# 启动GUI
python main.py

# 命令行选项
python main.py --config my_config.json  # 加载配置
python main.py --headless              # 无界面模式
python main.py --debug                # 调试模式
```

#### 初始化流程
1. 系统控制器初始化
2. 各阶段回零操作
3. 碰撞检测启用
4. 设备状态自检
5. GUI界面就绪

### 基本操作流程

#### 阶段控制
1. **选择目标阶段**：点击对应标签页
2. **输入目标位置**：填写X、Y、Z坐标
3. **设置运动参数**：调整速度和加速度
4. **执行移动**：点击"Move"按钮
5. **监控状态**：观察实时位置变化

#### 探针操作
1. **定位探针**：移动到目标上方
2. **设置按压参数**：目标Z位置和力限制
3. **执行按压**：点击"Press Probe"
4. **监控压力**：观察实时的压力反馈
5. **收回探针**：完成后点击"Retract"

#### 芯片处理
1. **移动到源位置**：定位芯片上方
2. **装载芯片**：点击"Load Chip"
3. **移动到目标位置**：运输到测试区域
4. **卸载芯片**：点击"Unload Chip"

### 命令编辑器使用

#### 立即执行命令
1. 在命令编辑器中输入JSON命令
2. 点击"Send Command"立即执行
3. 观察结果和状态反馈

#### 队列执行命令
1. 修改execution.mode为"queued"
2. 设置优先级（可选）
3. 点击"Queue Command"加入执行队列
4. 系统按优先级自动执行

---

## 📊 性能和监控

### 性能指标

#### 实时性能
- **控制循环频率**：1,000Hz
- **GUI刷新率**：20FPS
- **命令响应时间**：<100ms
- **位置更新延迟**：<1ms

#### 精度性能
- **定位精度**：±0.1μm
- **重复精度**：±0.5μm
- **角度精度**：±0.001°
- **速度稳定性**：±1%

#### 资源使用
- **内存占用**：~300MB
- **CPU使用率**：15-25%
- **磁盘占用**：~150MB
- **网络带宽**：无（本地运行）

### 监控和诊断

#### 系统状态监控
```python
class SystemStatus:
    def __init__(self):
        self.state = SystemState.IDLE
        self.active_stages = []
        self.warnings = []
        self.performance_metrics = {
            'update_rate': 1000.0,  # Hz
            'cpu_usage': 20.0,      # %
            'memory_usage': 300,    # MB
        }
```

#### 日志系统
- **系统日志**：记录所有系统事件
- **操作日志**：记录用户操作历史
- **错误日志**：记录异常和错误
- **性能日志**：记录性能指标变化

---

## 🔧 配置和维护

### 系统配置

#### 阶段参数配置
```json
{
  "stages": {
    "six_axis": {
      "max_velocity": 100000,
      "max_acceleration": 500000,
      "max_jerk": 10000000,
      "position_tolerance": 0.1,
      "velocity_tolerance": 10.0
    }
  }
}
```

#### 安全设置配置
```json
{
  "safety": {
    "min_clearance": 1000.0,
    "prediction_time": 2.0,
    "auto_emergency_stop": true,
    "warning_distance": 2000.0,
    "force_limit_probe": 1000.0
  }
}
```

#### GUI偏好设置
```json
{
  "gui": {
    "window_width": 1400,
    "window_height": 900,
    "theme": "default",
    "font_size": 10,
    "show_position_trail": true,
    "auto_rotate_3d": false
  }
}
```

### 维护操作

#### 配置备份
- **自动备份**：每次启动自动备份配置
- **手动备份**：通过菜单手动导出
- **版本管理**：支持多版本配置切换
- **恢复机制**：一键恢复默认设置

#### 日常维护
- **日志清理**：定期清理过期日志文件
- **性能监控**：监控系统资源使用情况
- **更新检查**：检查软件和依赖更新
- **诊断工具**：内置诊断和测试工具

---

## 🚀 扩展开发

### 插件架构

#### 自定义阶段控制器
```python
class CustomStageController(BaseMotionController):
    def __init__(self):
        super().__init__("custom_stage", axis_limits)
        # 自定义初始化

    def _get_home_position(self):
        # 定义回零位置
        return StagePosition(move_home)

    def custom_operation(self, params):
        # 自定义操作
        pass
```

#### 自定义命令
```python
def handle_custom_command(self, command_data):
    command_type = command_data.get('command_type')

    if command_type == 'CUSTOM_ACTION':
        # 处理自定义命令
        return {'success': True, 'result': 'OK'}
    else:
        return {'success': False, 'error': 'Unknown command'}
```

### API扩展

#### 网络接口
- **RESTful API**：HTTP接口支持
- **WebSocket**：实时数据推送
- **MQTT**：消息队列集成
- **gRPC**：高性能RPC接口

#### 数据分析
- **历史数据**：运动轨迹分析
- **性能统计**：设备性能评估
- **预测维护**：基于数据的预测
- **报告生成**：自动化报告生成

---

## 📚 使用示例

### 基础测试序列
```json
{
  "description": "芯片测试基础序列",
  "commands": [
    {"command_id": "HM0001", "command_type": "HOME"},
    {"command_id": "CH0001", "command_type": "LOAD_CHIP"},
    {"command_id": "ST0002", "command_type": "MOVE"},
    {"command_id": "PR0001", "command_type": "PRESS_PROBE"},
    {"command_id": "PR0002", "command_type": "RETRACT_PROBE"},
    {"command_id": "CH0002", "command_type": "UNLOAD_CHIP"}
  ]
}
```

### 高级运动控制
```json
{
  "command_id": "ST0003",
  "command_type": "MOVE",
  "target_stage": "six_axis",
  "parameters": {
    "position": {
      "position": {"x": 10500, "y": 5200, "z": 100},
      "rotation": {"rx": 0.0, "ry": 0.0, "rz": 45.0}
    },
    "velocity": 50000,
    "acceleration": 500000
  },
  "execution": {
    "mode": "immediate",
    "priority": 5,
    "timeout": 30.0
  }
}
```

---

## ❓ 常见问题

### Q: 3D可视化显示异常？
A: 检查PyVista是否正确安装，系统会自动降级到2D模式。

### Q: 运动控制响应慢？
A: 确保系统负载不高，检查CPU使用情况。

### Q: 碰撞检测误报？
A: 调整安全间隙设置，或检查实际设备位置。

### Q: 命令执行失败？
A: 验证JSON语法，检查参数范围和目标阶段状态。

---

**文档版本**：1.0
**创建时间**：2026年1月20日
**适用版本**：激光二极管测试设备仿真环境 v1.0
**维护状态**：活跃